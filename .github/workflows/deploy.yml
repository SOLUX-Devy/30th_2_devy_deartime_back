name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/deartime:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/deartime:latest

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            # Docker ÏÑ§Ïπò ÌôïÏù∏
            if ! command -v docker &> /dev/null; then
              echo "ERROR: Docker is not installed. Please install Docker on EC2 first."
              exit 1
            fi
            
            # Ïï± ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
            mkdir -p ~/deartime
            cd ~/deartime
            
            # 1. ÏµúÏã† Ïù¥ÎØ∏ÏßÄ Î®ºÏ†Ä Pull (Îã§Ïö¥ÌÉÄÏûÑ ÏµúÏÜåÌôî)
            echo "Pulling latest image..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/deartime:latest
            
            # 2. ÌôòÍ≤Ω Î≥ÄÏàò ÌååÏùº ÏÉùÏÑ± (Î≥¥Ïïà Í∞ïÌôî)
            echo "Creating environment file..."
            cat > deartime.env << 'EOF'
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            APP_BASE_URL=${{ secrets.APP_BASE_URL }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
            EOF
            chmod 600 deartime.env
            
            # 3. Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è ÏÇ≠Ï†ú
            echo "Stopping existing container..."
            sudo docker stop deartime-app || true
            sudo docker rm deartime-app || true
            
            # 4. ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
            echo "Starting new container..."
            sudo docker run -d \
              --name deartime-app \
              --restart always \
              -p 8080:8080 \
              --env-file deartime.env \
              ${{ secrets.DOCKER_USERNAME }}/deartime:latest
            
            # 5. Health Check (ÏµúÎåÄ 10Î≤à, 5Ï¥à Í∞ÑÍ≤©)
            echo "Waiting for application to start..."
            HEALTHY=0
            for i in {1..10}; do
              if curl -fsS http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "‚úÖ Application is healthy!"
                HEALTHY=1
                break
              else
                echo "Waiting for application... ($i/10)"
                sleep 5
              fi
            done
            
            if [ $HEALTHY -eq 0 ]; then
              echo "‚ùå Application failed to become healthy!"
              echo "Recent logs:"
              sudo docker logs --tail 100 deartime-app || true
              exit 1
            fi
            
            # 6. ÎØ∏ÏÇ¨Ïö© Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
            echo "Cleaning up old images..."
            sudo docker image prune -f
            
            echo "üöÄ Deployment completed successfully!"

